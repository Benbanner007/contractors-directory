---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ContractorCard from '../../components/contractor/ContractorCard.astro';
import ContractorFilters from '../../components/contractor/ContractorFilters.astro';
import { contractorDb } from '../../lib/database';

// Fetch contractors from database
const contractors = contractorDb.getAll();

const title = "Find Contractors in the Triangle - Licensed & Insured Professionals";
const description = "Browse our directory of verified contractors in Raleigh, Durham, Chapel Hill and surrounding areas. Find licensed plumbers, electricians, roofers, HVAC specialists and more.";

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Triangle Contractors Directory",
  "description": description,
  "url": "https://trianglecontractorshub.com/contractors",
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": contractors.length,
    "itemListElement": contractors.map((contractor, index) => ({
      "@type": "LocalBusiness",
      "position": index + 1,
      "name": contractor.businessName,
      "description": contractor.description,
      "telephone": contractor.phone,
      "url": contractor.website,
      "address": {
        "@type": "PostalAddress",
        "streetAddress": contractor.address.street,
        "addressLocality": contractor.address.city,
        "addressRegion": contractor.address.state,
        "postalCode": contractor.address.zipCode
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": contractor.rating,
        "reviewCount": contractor.reviewCount
      }
    }))
  }
};
---

<BaseLayout title={title} description={description} structuredData={structuredData}>
  <div class="contractors-page">
    <!-- Page Header -->
    <section class="page-header">
      <div class="container">
        <div class="header-content">
          <h1>Find Trusted Contractors</h1>
          <p class="header-description">
            Browse our directory of {contractors.length} verified contractors serving the Triangle area. 
            All contractors are licensed, insured, and background checked.
          </p>
          
          <div class="header-stats">
            <div class="stat">
              <span class="stat-number">{contractors.length}+</span>
              <span class="stat-label">Contractors</span>
            </div>
            <div class="stat">
              <span class="stat-number">{contractors.reduce((sum, c) => sum + c.reviewCount, 0)}+</span>
              <span class="stat-label">Reviews</span>
            </div>
            <div class="stat">
              <span class="stat-number">{(contractors.reduce((sum, c) => sum + c.rating, 0) / contractors.length).toFixed(1)}★</span>
              <span class="stat-label">Avg Rating</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <section class="main-content">
      <div class="container">
        <div class="content-grid">
          <!-- Filters Sidebar -->
          <aside class="filters-sidebar">
            <ContractorFilters />
          </aside>
          
          <!-- Contractors Grid -->
          <main class="contractors-section">
            <div class="section-header">
              <div class="results-info">
                <h2 id="results-count">Showing {contractors.length} contractors</h2>
                <p class="results-subtitle">Licensed and insured professionals in your area</p>
              </div>
              
              <div class="sort-controls">
                <label for="sort-select" class="sort-label">Sort by:</label>
                <select id="sort-select" class="sort-select" onchange="sortContractors()">
                  <option value="rating">Highest Rated</option>
                  <option value="reviews">Most Reviews</option>
                  <option value="experience">Most Experienced</option>
                  <option value="name">Name A-Z</option>
                </select>
              </div>
            </div>
            
            <div id="contractors-grid" class="contractors-grid">
              {contractors.map(contractor => (
                <ContractorCard contractor={contractor} />
              ))}
            </div>
            
            <div id="no-results" class="no-results" style="display: none;">
              <div class="no-results-content">
                <h3>No contractors found</h3>
                <p>Try adjusting your filters or search terms to find more contractors.</p>
                <button type="button" onclick="clearAllFilters()" class="btn-clear">
                  Clear All Filters
                </button>
              </div>
            </div>
            
            <!-- Load More Button (for future pagination) -->
            <div class="load-more-section" style="display: none;">
              <button class="load-more-btn">Load More Contractors</button>
            </div>
          </main>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="container">
        <div class="cta-content">
          <h2>Can't Find What You're Looking For?</h2>
          <p>Post your project and get quotes from qualified contractors in your area.</p>
          <a href="/post-project" class="cta-button">Post Your Project</a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-text">
            <p>&copy; 2024 Triangle Contractors Hub. All rights reserved.</p>
          </div>
          <div class="footer-links">
            <a href="/privacy" class="footer-link">Privacy Policy</a>
            <a href="/terms" class="footer-link">Terms of Service</a>
            <a href="/admin/contractors" class="footer-link admin-link">Admin</a>
          </div>
        </div>
      </div>
    </footer>
  </div>
</BaseLayout>

<style>
  .contractors-page {
    min-height: 100vh;
  }
  
  /* Page Header */
  .page-header {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
    color: white;
    padding: var(--space-16) 0 var(--space-12);
    position: relative;
    overflow: hidden;
  }
  
  .page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M20 20c0 11.046-8.954 20-20 20v20h40V20H20z'/%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.1;
  }
  
  .header-content {
    position: relative;
    z-index: 1;
    text-align: center;
  }
  
  .page-header h1 {
    font-size: var(--font-size-4xl);
    font-weight: 700;
    margin-bottom: var(--space-4);
    line-height: 1.2;
  }
  
  .header-description {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-8);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    opacity: 0.95;
  }
  
  .header-stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    flex-wrap: wrap;
  }
  
  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
  }
  
  .stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
  }
  
  .stat-label {
    font-size: var(--font-size-sm);
    opacity: 0.9;
  }
  
  /* Main Content */
  .main-content {
    padding: var(--space-12) 0;
    background: var(--gray-50);
  }
  
  .content-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: var(--space-8);
    align-items: start;
  }
  
  .filters-sidebar {
    position: relative;
  }
  
  .contractors-section {
    min-height: 600px;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-8);
    flex-wrap: wrap;
    gap: var(--space-4);
  }
  
  .results-info h2 {
    font-size: var(--font-size-2xl);
    color: var(--gray-900);
    margin-bottom: var(--space-2);
  }
  
  .results-subtitle {
    color: var(--gray-600);
    font-size: var(--font-size-base);
  }
  
  .sort-controls {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  
  .sort-label {
    font-weight: 600;
    color: var(--gray-700);
    font-size: var(--font-size-sm);
  }
  
  .sort-select {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    background: white;
    min-width: 160px;
  }
  
  .contractors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }
  
  .no-results {
    text-align: center;
    padding: var(--space-12) var(--space-6);
    background: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }
  
  .no-results-content h3 {
    font-size: var(--font-size-xl);
    color: var(--gray-900);
    margin-bottom: var(--space-3);
  }
  
  .no-results-content p {
    color: var(--gray-600);
    margin-bottom: var(--space-6);
  }
  
  .btn-clear {
    background: var(--primary-600);
    color: white;
    border: none;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  
  .btn-clear:hover {
    background: var(--primary-700);
  }
  
  .load-more-section {
    text-align: center;
    margin-top: var(--space-8);
  }
  
  .load-more-btn {
    background: white;
    color: var(--primary-600);
    border: 2px solid var(--primary-600);
    padding: var(--space-4) var(--space-8);
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  
  .load-more-btn:hover {
    background: var(--primary-50);
  }
  
  /* CTA Section */
  .cta-section {
    background: white;
    padding: var(--space-16) 0;
    border-top: 1px solid var(--gray-200);
  }
  
  .cta-content {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
  }
  
  .cta-content h2 {
    font-size: var(--font-size-2xl);
    color: var(--gray-900);
    margin-bottom: var(--space-4);
  }
  
  .cta-content p {
    color: var(--gray-600);
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-6);
  }
  
  .cta-button {
    display: inline-flex;
    align-items: center;
    background: var(--primary-600);
    color: white;
    padding: var(--space-4) var(--space-8);
    border-radius: var(--border-radius);
    font-weight: 600;
    text-decoration: none;
    transition: var(--transition);
  }
  
  .cta-button:hover {
    background: var(--primary-700);
    text-decoration: none;
  }
  
  /* Responsive Design */
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
      gap: var(--space-6);
    }
    
    .contractors-grid {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    .page-header {
      padding: var(--space-12) 0 var(--space-8);
    }
    
    .page-header h1 {
      font-size: var(--font-size-3xl);
    }
    
    .header-description {
      font-size: var(--font-size-base);
    }
    
    .header-stats {
      gap: var(--space-6);
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .contractors-grid {
      grid-template-columns: 1fr;
    }
    
    .sort-controls {
      width: 100%;
      justify-content: space-between;
    }
  }
  
  @media (max-width: 480px) {
    .main-content {
      padding: var(--space-8) 0;
    }
    
    .contractors-grid {
      gap: var(--space-4);
    }
  }

  /* Styles for dynamically generated contractor cards */
  .contractor-card {
    background: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    padding: var(--space-6);
    transition: var(--transition);
    border: 1px solid var(--gray-200);
    height: fit-content;
  }
  
  .contractor-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }
  
  .contractor-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-4);
  }
  
  .contractor-card .contractor-badges {
    display: flex;
    gap: var(--space-2);
    flex-direction: column;
    align-items: flex-end;
  }
  
  .contractor-card .badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--border-radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .contractor-card .badge.licensed {
    background: var(--green-100);
    color: var(--green-800);
  }
  
  .contractor-card .badge.insured {
    background: var(--blue-100);
    color: var(--blue-800);
  }
  
  .contractor-card .card-content {
    margin-bottom: var(--space-6);
  }
  
  .contractor-card .business-name {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-1);
    line-height: 1.3;
  }
  
  .contractor-card .contractor-name {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    margin-bottom: var(--space-3);
  }
  
  .contractor-card .rating-section {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }
  
  .contractor-card .stars {
    font-size: var(--font-size-lg);
    line-height: 1;
  }
  
  .contractor-card .stars-filled {
    color: var(--yellow-500);
  }
  
  .contractor-card .stars-half {
    color: var(--yellow-300);
  }
  
  .contractor-card .stars-empty {
    color: var(--gray-300);
  }
  
  .contractor-card .rating-text {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
  }
  
  .contractor-card .specialties {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }
  
  .contractor-card .specialty-tag {
    background: var(--primary-50);
    color: var(--primary-700);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--border-radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 500;
  }
  
  .contractor-card .description {
    color: var(--gray-600);
    line-height: 1.5;
    margin-bottom: var(--space-3);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .contractor-card .location, 
  .contractor-card .service-areas, 
  .contractor-card .experience {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }
  
  .contractor-card .service-areas {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-1);
  }
  
  .contractor-card .card-footer {
    border-top: 1px solid var(--gray-200);
    padding-top: var(--space-4);
  }
  
  .contractor-card .contact-info {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
  }
  
  .contractor-card .phone-link, 
  .contractor-card .website-link {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--primary-600);
    text-decoration: none;
    font-size: var(--font-size-sm);
    font-weight: 500;
  }
  
  .contractor-card .phone-link:hover, 
  .contractor-card .website-link:hover {
    color: var(--primary-700);
    text-decoration: underline;
  }
  
  .contractor-card .action-buttons {
    display: flex;
    gap: var(--space-3);
  }
  
  .contractor-card .btn-quote, 
  .contractor-card .btn-view {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--border-radius);
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    transition: var(--transition);
    border: none;
    cursor: pointer;
    font-size: var(--font-size-sm);
  }
  
  .contractor-card .btn-quote {
    background: var(--primary-600);
    color: white;
  }
  
  .contractor-card .btn-quote:hover {
    background: var(--primary-700);
  }
  
  .contractor-card .btn-view {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
  }
  
  .contractor-card .btn-view:hover {
    background: var(--gray-200);
    text-decoration: none;
  }

  /* Footer */
  .site-footer {
    background: var(--gray-900);
    color: var(--gray-300);
    padding: var(--space-8) 0;
    margin-top: var(--space-16);
  }

  .footer-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .footer-text p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--gray-400);
  }

  .footer-links {
    display: flex;
    gap: var(--space-6);
    align-items: center;
  }

  .footer-link {
    color: var(--gray-400);
    text-decoration: none;
    font-size: var(--font-size-sm);
    transition: var(--transition);
  }

  .footer-link:hover {
    color: var(--gray-200);
    text-decoration: none;
  }

  .footer-link.admin-link {
    color: var(--gray-500);
    font-size: var(--font-size-xs);
    opacity: 0.7;
  }

  .footer-link.admin-link:hover {
    color: var(--gray-400);
    opacity: 1;
  }

  @media (max-width: 768px) {
    .footer-content {
      flex-direction: column;
      text-align: center;
      gap: var(--space-3);
    }

    .footer-links {
      gap: var(--space-4);
    }
  }
</style>

<script is:inline define:vars={{ contractors }}>
  // Store original contractors data
  const allContractors = contractors;
  let filteredContractors = [...allContractors];
  
  console.log('Contractors loaded:', allContractors.length);

  // Listen for filter events
  window.addEventListener('contractorFilter', (event) => {
    console.log('Filter event received:', event.detail);
    const filters = event.detail;
    applyFilters(filters);
  });

  function applyFilters(filters) {
    console.log('Applying filters:', filters);
    filteredContractors = allContractors.filter(contractor => {
      // Search term filter
      if (filters.searchTerm) {
        const searchable = `${contractor.name} ${contractor.businessName} ${contractor.specialties.join(' ')} ${contractor.description}`.toLowerCase();
        if (!searchable.includes(filters.searchTerm)) return false;
      }
      
      // Category filter
      if (filters.selectedCategory && contractor.category !== filters.selectedCategory) {
        return false;
      }
      
      // Location filter
      if (filters.selectedLocation && !contractor.serviceAreas.includes(filters.selectedLocation)) {
        return false;
      }
      
      // Rating filter
      if (filters.minRating && contractor.rating < filters.minRating) {
        return false;
      }
      
      // Experience filter
      if (filters.selectedExperience && contractor.yearsInBusiness < filters.selectedExperience) {
        return false;
      }
      
      // Credential filters
      if (filters.licensedRequired && !contractor.licensed) {
        return false;
      }
      
      if (filters.insuredRequired && !contractor.insured) {
        return false;
      }
      
      return true;
    });
    
    updateDisplay();
  }

  function sortContractors() {
    const sortBy = document.getElementById('sort-select').value;
    
    filteredContractors.sort((a, b) => {
      switch (sortBy) {
        case 'rating':
          return b.rating - a.rating;
        case 'reviews':
          return b.reviewCount - a.reviewCount;
        case 'experience':
          return b.yearsInBusiness - a.yearsInBusiness;
        case 'name':
          return a.businessName.localeCompare(b.businessName);
        default:
          return 0;
      }
    });
    
    updateDisplay();
  }

  function updateDisplay() {
    console.log('Updating display with', filteredContractors.length, 'contractors');
    const grid = document.getElementById('contractors-grid');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    
    if (filteredContractors.length === 0) {
      grid.style.display = 'none';
      noResults.style.display = 'block';
      resultsCount.textContent = 'No contractors found';
    } else {
      grid.style.display = 'grid';
      noResults.style.display = 'none';
      resultsCount.textContent = `Showing ${filteredContractors.length} contractor${filteredContractors.length !== 1 ? 's' : ''}`;
      
      // Update grid HTML (simplified version - in a real app you'd use a more sophisticated approach)
      grid.innerHTML = filteredContractors.map(contractor => {
        const stars = getStarRating(contractor.rating);
        return `
          <div class="contractor-card">
            <div class="card-header">
              <div class="contractor-badges">
                ${contractor.licensed ? '<span class="badge licensed">Licensed</span>' : ''}
                ${contractor.insured ? '<span class="badge insured">Insured</span>' : ''}
              </div>
            </div>
            <div class="card-content">
              <h3 class="business-name">${contractor.businessName}</h3>
              <p class="contractor-name">by ${contractor.name}</p>
              <div class="rating-section">
                <div class="stars">
                  <span class="stars-filled">${stars.full}</span>
                  <span class="stars-half">${stars.half}</span>
                  <span class="stars-empty">${stars.empty}</span>
                </div>
                <span class="rating-text">${contractor.rating} (${contractor.reviewCount} reviews)</span>
              </div>
              <div class="specialties">
                ${contractor.specialties.slice(0, 3).map(specialty => 
                  `<span class="specialty-tag">${specialty}</span>`
                ).join('')}
              </div>
              <p class="description">${contractor.description}</p>
              <div class="location">
                <span class="location-icon">📍</span>
                <span>${contractor.address.city}, ${contractor.address.state}</span>
              </div>
              <div class="service-areas">
                <strong>Service Areas:</strong> ${contractor.serviceAreas.join(', ')}
              </div>
              <div class="experience">
                <span class="experience-icon">🏆</span>
                <span>${contractor.yearsInBusiness} years in business</span>
              </div>
            </div>
            <div class="card-footer">
              <div class="contact-info">
                <a href="tel:${contractor.phone}" class="phone-link">📞 ${contractor.phone}</a>
                ${contractor.website ? `<a href="${contractor.website}" target="_blank" rel="noopener" class="website-link">🌐 Website</a>` : ''}
              </div>
              <div class="action-buttons">
                <button class="btn-quote">Get Quote</button>
                <a href="/contractors/${contractor.category}/${contractor.id}" class="btn-view">View Profile</a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  function getStarRating(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    
    return {
      full: '★'.repeat(fullStars),
      half: hasHalfStar ? '☆' : '',
      empty: '☆'.repeat(emptyStars)
    };
  }

  // Initialize display on page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing display...');
    updateDisplay();
  });

  // Make functions available globally
  window.sortContractors = sortContractors;
  window.clearAllFilters = function() {
    filteredContractors = [...allContractors];
    updateDisplay();
  }
</script>